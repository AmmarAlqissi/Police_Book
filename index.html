<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>كتيب إجراءات الشرطة التفاعلي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Application Structure Plan: 
        - Layout: Two-column layout. Left fixed sidebar for navigation based on the "الفهرس". Right column for content display.
        - Header: Application title and a search bar.
        - Content Display: Each section from the booklet is a view in the right column. Sub-sections use headings and lists. Collapsible accordions for dense information.
        - Interactivity: Sidebar navigation, search functionality (highlighting text in the current section), Chart.js for "أعداد الشرطة في السرقات", HTML/CSS diagram for "سلم الصلاحيات", and a new LLM-powered "Quick Consultation" feature.
        - User Flow: Land on page (first section visible) -> Navigate via sidebar -> Expand/collapse details -> Search for terms -> Use LLM for quick consultation.
        - Why this structure?: Familiar navigation for manuals, organized, scalable, focused content view, with added AI utility.
    -->
    <!-- Visualization & Content Choices:
        - الفهرس -> Sidebar Navigation (HTML list, JS for content switching). Goal: Navigate. Justification: Standard.
        - Text Sections -> Formatted text, collapsible accordions (HTML, JS). Goal: Inform, Detail. Justification: Readability.
        - 2.1.3 أعداد الشرطة في السرقات -> Horizontal Bar Chart (Chart.js). Goal: Compare, Inform. Justification: Visual comparison of staffing.
        - 3.0 أولوية التعامل مع الحالات -> Styled HTML sections (HTML, Tailwind). Goal: Inform, Categorize. Justification: Clear structure.
        - 3.1 سلم الصلاحيات -> HTML/CSS Diagram (Nested divs, Tailwind). Goal: Organize, Inform. Justification: Visual hierarchy.
        - Search -> Input field, JS for highlighting. Goal: Explore, Find. Justification: Quick info retrieval.
        - استشارة سريعة (LLM Feature) -> Text input, button, text output (HTML, JS, Gemini API). Goal: Consult, Generate insights. Justification: Provides AI-powered assistance based on the booklet's context.
    -->
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .content-section {
            display: none;
        }
        .content-section.active {
            display: block;
        }
        .sidebar-link.active {
            background-color: #0284c7; /* sky-600 */
            color: white;
        }
        .accordion-button::after {
            content: '+';
            float: left;
            margin-left: 5px;
        }
        .accordion-button.open::after {
            content: '-';
        }
        mark {
            background-color: #fde047; /* yellow-400 */
            padding: 0.1em;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            height: auto; /* Adjusted for dynamic content */
            min-height: 300px; /* Minimum height */
            max-height: 500px; /* Maximum height */
        }
        /* RTL adjustments for accordion icon */
        html[dir="rtl"] .accordion-button::after {
            float: right;
            margin-left: 0;
            margin-right: 5px;
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #0284c7; /* sky-600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="flex flex-col md:flex-row min-h-screen">
        <aside id="sidebar" class="w-full md:w-72 bg-slate-800 text-slate-100 p-4 space-y-2 fixed md:sticky top-0 h-screen overflow-y-auto transition-transform transform md:translate-x-0 -translate-x-full z-20">
            <button id="close-sidebar-btn" class="md:hidden text-white absolute top-4 left-4 text-2xl">&times;</button>
            <h2 class="text-xl font-semibold mb-4">الفهرس</h2>
            <nav id="toc-nav">
                </nav>
        </aside>

        <main class="flex-1 p-4 md:p-8 overflow-y-auto">
            <header class="mb-6 flex flex-col sm:flex-row justify-between items-center">
                <div class="flex items-center">
                    <button id="menu-toggle-btn" class="md:hidden text-slate-800 text-2xl mr-4">&#9776;</button>
                    <h1 class="text-2xl sm:text-3xl font-bold text-sky-700">كتيب إجراءات الشرطة التفاعلي</h1>
                </div>
                <div class="mt-4 sm:mt-0 w-full sm:w-auto">
                    <input type="text" id="search-input" placeholder="ابحث في القسم الحالي..." class="p-2 border border-slate-300 rounded-md w-full sm:w-64 focus:ring-sky-500 focus:border-sky-500">
                </div>
            </header>

            <div id="content-area">
                </div>
        </main>
    </div>

    <script>
        const toc = [
            { id: "intro", title: "مقدمة الكتيب" },
            { id: "s1_0", title: "1.0 قواعد الشرطة" },
            { id: "s1_1", title: "1.1 التعريفات" },
            { id: "s1_2", title: "1.2 حقوق الشرطة" },
            { id: "s1_3", title: "1.3 آلية التعامل مع الحالات الجنائية" },
            { id: "s1_4", title: "1.4 بروتوكولات التعامل بين شرطي و شرطي" },
            { id: "s1_5", title: "1.5 انضباط الشرطة" },
            { id: "s1_6", title: "1.6 قواعد سلوكيات تعامل الشرطة مع المواطنين" },
            { id: "s1_7", title: "1.7 قواعد وسلوكيات التعامل مع مجرم أو مشتبه" },
            { id: "s1_8", title: "1.8 قواعد وسلوكيات التعامل مع الحالات" },
            { id: "s1_9", title: "1.9 قواعد وسلوكيات التعامل مع المطاردة" },
            { id: "s2_0", title: "2.0 بروتوكولات التفاوض" },
            { id: "s2_1", title: "2.1 أحكام أخرى للسرقات" },
            { id: "s2_2", title: "2.2 حقوق المواطنين" },
            { id: "s2_3", title: "2.3 قواعد وسلوكيات التعامل مع أفراد الطاقم الطبي" },
            { id: "s2_4", title: "2.4 قواعد وسلوكيات عامة" },
            { id: "s2_5", title: "2.5 قواعد وسلوكيات المجرمين" },
            { id: "s2_6", title: "2.6 الأسلحة والذخائر" },
            { id: "s2_7", title: "2.7 ترخيص استخدام الأسلحة للمواطنين" },
            { id: "s2_8", title: "2.8 بروتوكولات وقوانين التقاعد" },
            { id: "s2_9", title: "2.9 التحذيرات و المحاسبات" },
            { id: "s3_0", title: "3.0 أولوية التعامل مع الحالات" },
            { id: "s3_1", title: "3.1 سلم الصلاحيات" }, 
            { id: "llm_consultation", title: "استشارة سريعة ✨" }
        ];

        const contentData = {
            "intro": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">مقدمة الكتيب</h2>
                    <p class="mb-4">مرحباً بك في النسخة التفاعلية من كتيب إجراءات التشغيل القياسية لشرطة سان أندرياس - قسم شرطة Storm City. يهدف هذا الكتيب إلى توفير مرجع شامل وواضح لجميع القواعد والبروتوكولات والإجراءات التي يجب على أفراد الشرطة اتباعها لضمان تطبيق القانون وحماية المواطنين والممتلكات بكفاءة ومهنية عالية.</p>
                    <p class="mb-4">تم تصميم هذا التطبيق لتسهيل الوصول إلى المعلومات واستعراضها بشكل تفاعلي. يمكنك التنقل بين الأقسام المختلفة باستخدام الفهرس الجانبي، والبحث عن مصطلحات محددة، واستكشاف بعض البيانات بشكل مرئي.</p>
                    <div class="mt-6 p-4 bg-sky-50 border-r-4 border-sky-500 rounded">
                        <h3 class="text-lg font-semibold text-sky-600 mb-2">شعار القسم:</h3>
                        <p class="text-xl font-medium">"To protect and to serve"</p>
                        <p class="mt-1 text-sm text-slate-600">(للحماية والخدمة)</p>
                    </div>
                </div>
            `,
            "s1_0": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">1.0 قواعد الشرطة</h2>
                    <p class="mb-4">شرطة لوس سانتوس تهدف لحماية النظام الأمني القومي والنظام العام وممتلكات ومناطق مدينة لوس سانتوس، وحماية المواطنين هي أولى اهتماماتنا. وعلى الشرطي التنبؤ بالتعامل مع الحالات بالشكل الذي يناسب هيئته كشرطي وتبعاً لكتيب بروتوكولات الشرطة. تمثل الشرطة السلطة التنفيذية للقانون في المجتمع، وتعمل على تطبيق الأنظمة والتشريعات المحلية والوطنية. يعمل أفراد الشرطة على حماية المواطنين والممتلكات، ومنع الجرائم والمخالفات، وتحقيق العدالة في حالات الانتهاكات للقانون.</p>
                    <h3 class="text-xl font-semibold text-sky-600 mt-4 mb-2">1. قواعد وسلوكيات التعامل</h3>
                    <p>قواعد وسلوكيات التعامل تمثل هيئة الشرطة بشكل عام أمام المجتمع من ناحية الإجراءات والحماية والتنفيذ، وطرق التعامل في الآلية التي تبرز هيئة الشرطة من طرف عناصر الشرطة.</p>
                </div>
            `,
            "s1_1": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">1.1 التعريفات</h2>
                    <p class="mb-4">هذا القسم يوضح المصطلحات الأساسية المستخدمة في هذا الكتيب لضمان فهم موحد للإجراءات والقوانين. فهم هذه التعريفات ضروري لجميع أفراد الشرطة لتطبيق البروتوكولات بشكل صحيح وفعال.</p>
                    <ul class="space-y-3 list-inside">
                        <li><strong>1. المشتبه به:</strong> المشتبه به هو مواطن يشتبه في تورطه في جريمة جنائية. حيث يكون المشتبه به عادة يتصف بالأوصاف التالية:
                            <ol class="list-decimal list-inside pr-6 mt-1 space-y-1">
                                <li>ارتداء ملابس مثيرة للاشتباه مثل القناع أو حامل السلاح أو الدرع المضاد للرصاص.</li>
                                <li>وجوده بالقرب من موقع ارتكاب الجريمة.</li>
                                <li>وجود دافع لديه لارتكاب الجريمة.</li>
                                <li>إدلائه بتصريحات غير مباشرة تشير إلى ارتكاب الجريمة.</li>
                            </ol>
                        </li>
                        <li><strong>2. المجرمون:</strong> هم أشخاص قاموا بتنفيذ أعمال إجرامية وثبتت عليهم.</li>
                        <li><strong>3. حقوق ميراندا:</strong> هي مجموعة من الحقوق التي تمنح للمشتبه به أثناء التحقيق الجنائي أو أثناء القبض على شخص، تتضمن الحق في التزام الصمت، وتنبيه المشتبه به بأن أي شيء يقوله قد يستخدم ضده في المحكمة، وحق الحصول على محامي أثناء الاستجواب، وتكون كالتالي: (تم القبض عليك من شرطة Storm City بتهمة سرقة منزل / تكتفي بقول أعلى تهمة للمواطن / يحق لك التزام الصمت، أي شيء تقوله يستخدم ضدك في المحكمة، كذلك يحق لك توكيل محامي، وفي حال ما عندك المقدرة على توكيل محامي تتوفر لك الولاية محامي إن وجد).</li>
                        <li><strong>4. القوة المعقولة:</strong> هي استخدام القوة الضرورية والمناسبة للموقف في تأمين الانضباط وفرض القانون، مثل استخدام جهاز الصعق الكهربائي أو الضرب باليد للدفاع عن النفس أو لتقييد المخالف بما يتناسب مع خطورة الموقف ودون تجاوز الحدود المقررة.</li>
                        <li><strong>5. القوة المفرطة:</strong> هي استخدام القوة الزائدة، بما في ذلك استخدام السلاح الناري مباشرة، في حال كان يوجد خطر يشكل تهديدًا فوريًا للحياة.</li>
                        <li><strong>6. مركز العمليات:</strong> هو الشخص الذي يدير وينسق جميع الأنشطة والعمليات اليومية لوحدات الشرطة، يقوم بتلقي التقارير والبلاغات، ويتخذ القرارات اللازمة. التوجيه وتنسيق الفرق الميدانية والموارد اللازمة للاستجابة السريعة للحوادث والطوارئ وهو المحور الأساسي لتنظيم الوحدات وتوزيعها وتوجيهها للحالات والتأكد من العدد وتعيين مسؤول للحالات.</li>
                        <li><strong>7. مسؤول الفترة:</strong> هو الرتبة الأعلى في الميدان (يجب أن تكون رتبته Officer III فأعلى) ويكون عمله هو الإشراف على جميع الحالات وكتابة الملاحظات والأخطاء في حال وجدت وتقديمها للشؤون الداخلية وكذلك بدوره المسؤول يجيب عليه:
                            <ul class="list-disc list-inside pr-6 mt-1 space-y-1">
                                <li>التوجيه والإرشاد لمن حصل منه الخطأ.</li>
                                <li>من مهامه الاستجابة لطلبات المواطنين في حال لم يستطع أي شرطي أقل رتبة التعامل معها أن يأتي ويحاول التعامل معها بنفسه.</li>
                                <li>في حال لم يستطع التعامل مع مشكلة المواطن وحلها يطلب من المواطن التوجه لرفع شكوى رسمية ليتم مراجعة أمرها من إدارة الشرطة.</li>
                            </ul>
                        </li>
                        <li><strong>8. مسؤول الحالة:</strong> هو شخص يتم تعيينه من قبل مسؤول الفترة أو يمكن أن يكون مسؤول الفترة هو مسؤول الحالة، وفي حالة لم يكن هناك مسؤول للفترة يتم تعيين مشرف الحالة من قبل Dispatch ويفضل أن يكون الرتبة الأعلى في الميدان.
                            <p class="mt-1 pl-6">مهام مشرف الحالة في تنظيم ترتيب الوحدات في الموقع وكذلك اختيار المفاوض المناسب في حال وجدت رهينة، وأيضًا تقييم المعدات المناسبة للحالة مثل كم عدد الوحدات الأرضية التي تحتاجها؟ هل تحتاج وحدة جوية؟ وغيرها من الأسئلة المهم التي يجب عليه التفكير بها للنجاح بإنهاء الحالة على أكمل وجه.</p>
                        </li>
                        <li><strong>9. نائب مركز العمليات:</strong> يكون وسيلة مساعدة لمركز العمليات في عملية التوزيع والتنظيم (بالاتفاق مع الدس باتش) ويرد ويتولى المسؤولية عن العمليات في حال عدم قدرة الدس باتش على التبليغ بعد غياب الدس باتش الأساسي عن عدم الرد لمدة دقيقتين تتحول العمليات بشكل كامل مع النائب (أي عليه أن يكون متواجد في القسم).</li>
                    </ul>
                </div>
            `,
            "s1_2": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">1.2 حقوق الشرطة</h2>
                    <p class="mb-4">يتمتع أفراد الشرطة بمجموعة من الحقوق والسلطات التي تمكنهم من أداء واجباتهم بفعالية في تطبيق القانون وحماية المجتمع. هذا القسم يوضح هذه الحقوق الأساسية.</p>
                    <ol class="list-decimal list-inside space-y-2">
                        <li>تمنح الشرطة سلطات خاصة للتدخل والتصرف في الشؤون الأمنية وتطبيق القانون والتي لا يحق للمواطنين العاديين ممارستها، وتكون محصورة برجال الشرطة فقط.</li>
                        <li>يحق للشرطي طلب وفحص الوثائق الرسمية مثل الهوية ورخصة القيادة وأي وثائق أخرى ذات صلة لضمان تطبيق القانون وتأمين السلامة العامة.</li>
                        <li>يحق للشرطي إلقاء القبض على المجرمين والمطلوبين.</li>
                        <li>يسمح للشرطي باستخدام صافرات الإنذار خلال الحركة، وذلك للتنبيه والتحذير من المخاطر والتسهيل على حركة المرور أثناء تنفيذ مهامه الأمنية.</li>
                        <li>يحق للشرطة خرق قواعد المرور إذا كان ذلك ضروريًا لأداء واجباتهم، حيث يتم إعفاؤهم من معظم مواد قواعد المرور، هذا يعني أنه يسمح للشرطي بما يلي:
                            <ol class="list-alpha list-inside pr-6 mt-1 space-y-1">
                                <li>عبور الإشارة الحمراء.</li>
                                <li>استخدام أكتاف الطريق.</li>
                                <li>تجاوز الحد الأقصى للسرعة.</li>
                                <li>القيادة على الجانب الخطأ من الطريق.</li>
                                <li>تجاوز المركبات من اليمين.</li>
                                <li>تجاهل لوحات (stop) عند المنعطفات.</li>
                                <li>عكس السير.</li>
                            </ol>
                        </li>
                        <li>يسمح للشرطة باستخدام القوة اللازمة لأداء واجباتها وتطبيق القانون، ولكن يجب أن يكون الاستخدام متناسبًا مع الوضع ويحترم حقوق الأفراد.</li>
                        <li>يحق للشرطي تفتيش المواطن في حال كان مشتبه (يجب إبلاغ المواطن بالشكل الآتي: سيتم تفتيشك بسبب اشتباه بسرقة الخ، هل تسمح في التفتيش الموقع الحالي أو اصطحابك إلى المركز للتفتيش؟) في حال رفض يجب أخذ المواطن للمركز وتفتيشه.</li>
                        <li>يحق للشرطي التعامل مع المواطن الذي يزعجه بموجب القوانين المنصوص عليها. ويمكن أن يؤدي هذا التعامل في بعض الحالات إلى اعتقال المواطن.</li>
                        <li>يحق للشرطي سجن المجرمين بدون صدور اعتراف منهم بشرط وجود أدلة.</li>
                        <li>يسمح للشرطي بحجز وتفتيش المركبات المشبوهة أو المشاركة في أي أنشطة إجرامية، وذلك لضمان تطبيق القانون وحماية السلامة العامة.</li>
                        <li>يحق للمحققين التحقيق مع المشتبه بهم.</li>
                        <li>يسمح للشرطي باستخدام سلاحه في المواقف المشبوهة والخطرة، وخاصة في حالات السرقة والجرائم العنيفة.</li>
                        <li>يسمح للشرطي بالقبض على المواطن الذي يدخل مواقع غير مصرح له بها، مثل مكاتب الشرطة ومواقع الجرائم، بغرض حماية الأمن وتأمين المواقع.</li>
                        <li>يسمح للشرطي بتحرير مخالفات مالية وفقًا للقوانين المنصوص عليها.</li>
                        <li>تمنح هذه المادة الشرطي الحق في الالتزام بالصمت وعدم التحدث مع المجرم بعد انتهاء عملية إثبات التهم ضده، وذلك بغرض عرض مخالفاته وتحديد مقدار عقوبته.</li>
                    </ol>
                </div>
            `,
             "s2_1": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">2.1 أحكام أخرى للسرقات</h2>
                    <p class="mb-4">يتناول هذا القسم تفاصيل إضافية تتعلق بالتعامل مع حالات السرقات المختلفة، بما في ذلك العوامل التي قد تؤثر على سير عملية الهروب الآمن، والإجراءات المتبعة في حال عدم وجود رهائن، وتحديد أعداد أفراد الشرطة المناسبة لكل نوع من أنواع السرقات.</p>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-sky-600 mb-2">1. مفشلات الهروب الآمن:</h3>
                        <ul class="list-disc list-inside space-y-1">
                            <li>التوجه للبحر.</li>
                            <li>التدخل الخارجي.</li>
                            <li>دخول الورشة أو تعديل المركبة.</li>
                            <li>استخراج السلاح الناري بشكل صريح وواضح.</li>
                            <li>تعريض حياة المواطنين بشكل متعمد وواضح ومتكرر.</li>
                            <li>تغيير المركبة.</li>
                            <li>التوجه أو القرب إلى البحر.</li>
                            <li>في حال النزول من المركبة ومحاولة الهروب في مركبة أخرى يحق للعسكري استخدام التيزر بشكل مباشر.</li>
                            <li>بعد مرور الوقت المحدد من قبل مفاوض الشرطة (من وقت بدء المطاردة).</li>
                        </ul>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-xl font-semibold text-sky-600 mb-2">2. في حال عدم وجود رهينة:</h3>
                        <p>في حالة سرقة البقالة يتم صف المركبات أمام الموقع بشكل احترافي والوقوف بجانب باب المركبة واستخدام الباب كحاجز ورفع السلاح الصاعق وانتظار المجرم للخروج ورفع الصوت بإبلاغه أن يسلم نفسه. وفي حال دخل مركبته وهرب الاستكمال معه وفق القوانين الموضحة.</p>
                    </div>

                    <div>
                        <h3 class="text-xl font-semibold text-sky-600 mb-2">3. أعداد الشرطة في السرقات:</h3>
                        <p class="mb-3">يوضح الجدول التالي الحد الأدنى والأقصى لعدد أفراد الشرطة المطلوبين للتعامل مع أنواع السرقات المختلفة.</p>
                        <div class="chart-container h-auto md:h-[600px]">
                            <canvas id="robberyStaffingChart"></canvas>
                        </div>
                    </div>
                </div>
            `,
            // تم تحديث محتوى سلم الصلاحيات
            "s3_1": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">3.1 سلم الصلاحيات - (A.O.P)</h2>
                    <p class="mb-4">يوضح هذا القسم التسلسل الهرمي للصلاحيات والمسؤوليات داخل قسم الشرطة، وفقًا لنظام شرطة لوس أنجلوس (LAPD). فهم هذا السلم ضروري لضمان سير العمليات بفعالية واحترام التسلسل القيادي.</p>
                    <div class="space-y-6">
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">1. Chief of Police (رئيس الشرطة):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>أعلى سلطة في القسم، مسؤول عن القيادة العامة والإدارة الاستراتيجية.</li>
                                <li>يضع السياسات والأهداف الرئيسية للقسم.</li>
                                <li>يمثل القسم أمام الجمهور والجهات الحكومية.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">2. Assistant Chief (مساعد الرئيس):</h4>
                             <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>ثاني أعلى رتبة، يشرف على المكاتب الرئيسية (مثل مكتب العمليات، مكتب التحقيقات).</li>
                                <li>يقدم الدعم لرئيس الشرطة في الإدارة اليومية.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">3. Deputy Chief (نائب الرئيس):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>يقود مكتبًا أو قسمًا متخصصًا كبيرًا (مثل مكتب العمليات الميدانية، مكتب التحقيقات الجنائية).</li>
                                <li>مسؤول عن تنفيذ السياسات والإشراف على الأداء في نطاق مسؤوليته.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">4. Commander (قائد):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>يقود مجموعة من الأقسام أو وحدات متخصصة.</li>
                                <li>يشرف على العمليات اليومية ويضمن التنسيق بين الوحدات.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">5. Captain (نقيب):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>يقود قسمًا معينًا (مثل قسم الدوريات، قسم المباحث).</li>
                                <li>مسؤول عن إدارة الموارد البشرية والعمليات داخل قسمه.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">6. Lieutenant (ملازم):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>يشرف على وردية عمل أو وحدة متخصصة داخل قسم.</li>
                                <li>مسؤول عن التوجيه والإشراف المباشر على الرقباء والضباط.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">7. Sergeant (رقيب):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>المشرف المباشر الأول على الضباط في الميدان.</li>
                                <li>مسؤول عن تطبيق الإجراءات وضمان الامتثال للقواعد.</li>
                                <li>يقدم الدعم والتوجيه للضباط الأقل رتبة.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">8. Police Officer III (ضابط شرطة ثالث):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>ضابط ذو خبرة، وغالبًا ما يكون ضابط تدريب ميداني.</li>
                                <li>يقوم بمهام الدوريات والاستجابة للحوادث.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">9. Police Officer II (ضابط شرطة ثانٍ):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>ضابط دورية ذو خبرة متوسطة.</li>
                                <li>يقوم بمهام الدوريات والاستجابة للحوادث.</li>
                            </ul>
                        </div>
                        <div class="p-4 border border-slate-300 rounded-md bg-slate-50">
                            <h4 class="text-lg font-semibold text-sky-600">10. Police Officer I (ضابط شرطة أول):</h4>
                            <ul class="list-disc list-inside mt-2 space-y-1 pr-4">
                                <li>ضابط مبتدئ، يعمل تحت إشراف مباشر.</li>
                                <li>يتعلم الإجراءات والبروتوكولات الأساسية.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            `,
            "llm_consultation": `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">استشارة سريعة ✨</h2>
                    <p class="mb-4">استخدم هذا القسم للحصول على مساعدة فورية من نموذج الذكاء الاصطناعي الخاص بنا. يمكنك طرح أسئلة حول إجراءات معينة، أو طلب توضيح لموقف، أو الحصول على توجيهات عامة بناءً على محتوى الكتيب.</p>
                    <div class="mb-4">
                        <label for="llm-query-input" class="block text-slate-700 text-sm font-bold mb-2">اطرح سؤالك أو صف الموقف:</label>
                        <textarea id="llm-query-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-sky-500 focus:border-sky-500 h-32" placeholder="مثال: ما هي خطوات التعامل مع حالة خطف؟"></textarea>
                    </div>
                    <div class="mb-4 flex items-center">
                        <button id="llm-submit-btn" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition-colors">
                            احصل على استشارة ✨
                        </button>
                        <span id="llm-loading-indicator" class="hidden text-slate-600 text-sm mr-2">
                            <span class="loading-spinner"></span> جاري المعالجة...
                        </span>
                    </div>
                    <div id="llm-response-output" class="bg-slate-50 p-4 rounded-md border border-slate-200 min-h-[100px] text-slate-800 whitespace-pre-wrap">
                        الرد سيظهر هنا.
                    </div>
                </div>
            `
        };
        
        // ملء الأقسام الأخرى بمحتوى مؤقت أو مختصر
        toc.forEach(item => {
            if (!contentData[item.id]) {
                contentData[item.id] = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold text-sky-700 mb-3">${item.title}</h2>
                    <p class="mb-4">محتوى هذا القسم (${item.title}) قيد الإعداد أو سيتم إضافته بناءً على التفاصيل الكاملة للكتيب.</p>
                    <p>هذا القسم مخصص لتوضيح ${item.title.toLowerCase()} وكل ما يتعلق بها من إجراءات وقواعد لضمان سير العمل الشرطي بفعالية وأمان.</p>
                </div>`;
            }
        });


        const tocNav = document.getElementById('toc-nav');
        const contentArea = document.getElementById('content-area');
        const searchInput = document.getElementById('search-input');
        const menuToggleButton = document.getElementById('menu-toggle-btn');
        const sidebar = document.getElementById('sidebar');
        const closeSidebarButton = document.getElementById('close-sidebar-btn');

        let currentSectionId = toc[0].id;
        let originalContent = {}; // لتخزين المحتوى الأصلي لإعادة تعيين البحث

        function showSection(sectionId) {
            currentSectionId = sectionId;
            // إعادة تعيين التمييزات السابقة
            if (originalContent[currentSectionId]) {
                 const currentSectionDiv = document.getElementById(currentSectionId);
                 if(currentSectionDiv) currentSectionDiv.innerHTML = originalContent[currentSectionId];
            }

            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.add('active');
                // تخزين المحتوى الأصلي إذا لم يكن مخزناً بالفعل
                if (!originalContent[sectionId]) {
                    originalContent[sectionId] = activeSection.innerHTML;
                }
            }

            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });
            
            // معالجة خاصة لقسم المخططات
            if (sectionId === 's2_1') {
                setTimeout(initRobberyChart, 0); // التأكد من أن الكانفاس مرئي
            }
            // معالجة خاصة لقسم LLM
            if (sectionId === 'llm_consultation') {
                // لا يوجد تهيئة خاصة هنا، فقط التأكد من أن العناصر موجودة
            }


            // إخفاء الشريط الجانبي على الجوال بعد الاختيار
            if (window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
            }
            searchInput.value = ''; // مسح البحث عند تغيير القسم
        }

        function createAccordion(element) {
            const button = element.querySelector('.accordion-button');
            const content = element.querySelector('.accordion-content');
            if (button && content) {
                button.addEventListener('click', () => {
                    content.classList.toggle('hidden');
                    button.classList.toggle('open');
                });
            }
        }
        
        function initRobberyChart() {
            const chartCanvas = document.getElementById('robberyStaffingChart');
            if (!chartCanvas) return;
            if (chartCanvas.chart) { // تدمير المخطط الموجود إن وجد
                chartCanvas.chart.destroy();
            }

            const data = {
                labels: [
                    "سرقة بقالة", "سرقة منزل", "سرقة الكاش", "سرقة الديجتال", 
                    "سرقة سيارة البنك", "سرقة المصرف", "سرقة المكيفات", 
                    "سرقة الغسالات", "سرقة المجوهرات", "سرقة المتحف", 
                    "سرقة البوبكات", "سرقة المجوهرات الكبيرة", "سرقة الميز بنك"
                ],
                datasets: [
                    {
                        label: 'الحد الأدنى للشرطة',
                        data: [2, 3, 5, 4, 5, 4, 4, 5, 5, 6, 9, 6, 7],
                        backgroundColor: 'rgba(54, 162, 235, 0.6)', // أزرق
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'الحد الأقصى للشرطة',
                        data: [4, 5, 8, 6, 9, 8, 8, 7, 8, 12, 11, 13, 16],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)', // أحمر
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            };
            const config = {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y', // مخطط شريطي أفقي
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#334155' }, // slate-700
                            grid: { color: '#e2e8f0' } // slate-200
                        },
                        y: {
                            ticks: { color: '#334155', font: { size: 10 } },
                             grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#334155' }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleFont: { weight: 'bold'},
                            bodyFont: { size: 12 },
                            callbacks: {
                                title: function(tooltipItems) {
                                    return tooltipItems[0].label;
                                }
                            }
                        }
                    }
                }
            };
            chartCanvas.chart = new Chart(chartCanvas, config);
        }

        let highlightTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(highlightTimeout);
            highlightTimeout = setTimeout(performSearch, 300);
        });

        function performSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            const activeSectionDiv = document.getElementById(currentSectionId);

            if (!activeSectionDiv || !originalContent[currentSectionId]) return;

            // استعادة المحتوى الأصلي قبل البحث الجديد
            activeSectionDiv.innerHTML = originalContent[currentSectionId];
            
            // إعادة تهيئة الأكورديونات إذا كانت موجودة في المحتوى الأصلي
            activeSectionDiv.querySelectorAll('.accordion').forEach(createAccordion);
            // إعادة تهيئة المخطط إذا كان قسم المخطط
            if (currentSectionId === 's2_1') {
                 setTimeout(initRobberyChart, 0);
            }


            if (searchTerm === '') {
                return; // لا يوجد مصطلح بحث، المحتوى الأصلي مستعاد بالفعل
            }

            const textNodes = [];
            function getTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    if (node.nodeValue.trim() !== '') {
                         // تجنب تمييز محتوى السكريبت/النمط إذا تم تضمينه عن طريق الخطأ
                        if (node.parentNode.nodeName !== 'SCRIPT' && node.parentNode.nodeName !== 'STYLE') {
                            textNodes.push(node);
                        }
                    }
                } else {
                    for (const childNode of node.childNodes) {
                        // عدم التكرار في الكانفاس أو حاويته
                        if (node.id === 'robberyStaffingChart' || node.classList.contains('chart-container')) continue;
                        getTextNodes(childNode);
                    }
                }
            }

            getTextNodes(activeSectionDiv);
            
            textNodes.forEach(node => {
                const text = node.nodeValue;
                const lowerText = text.toLowerCase();
                let matchIndex = lowerText.indexOf(searchTerm);
                if (matchIndex !== -1) {
                    const fragment = document.createDocumentFragment();
                    let lastIndex = 0;
                    while (matchIndex !== -1) {
                        // إضافة نص قبل المطابقة
                        fragment.appendChild(document.createTextNode(text.substring(lastIndex, matchIndex)));
                        // إضافة المطابقة المميزة
                        const mark = document.createElement('mark');
                        mark.textContent = text.substring(matchIndex, matchIndex + searchTerm.length);
                        fragment.appendChild(mark);
                        
                        lastIndex = matchIndex + searchTerm.length;
                        matchIndex = lowerText.indexOf(searchTerm, lastIndex);
                    }
                    // إضافة نص بعد آخر مطابقة
                    fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                    node.parentNode.replaceChild(fragment, node);
                }
            });
        }
        
        menuToggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });
        closeSidebarButton.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
        });

        // وظيفة استدعاء Gemini API
        async function callGeminiAPI() {
            const queryInput = document.getElementById('llm-query-input');
            const responseOutput = document.getElementById('llm-response-output');
            const loadingIndicator = document.getElementById('llm-loading-indicator');
            const submitButton = document.getElementById('llm-submit-btn');

            const prompt = queryInput.value.trim();

            if (!prompt) {
                responseOutput.textContent = "الرجاء إدخال استفسارك.";
                return;
            }

            loadingIndicator.classList.remove('hidden');
            submitButton.disabled = true;
            responseOutput.textContent = ""; // مسح الرد السابق

            try {
                let chatHistory = [];
                // يمكن تحسين هذا الموجه ليشمل مقتطفات من الكتيب إذا كان ذلك ممكناً دون تجاوز حدود الرمز المميز
                chatHistory.push({ role: "user", parts: [{ text: `أنت خبير في كتيب إجراءات التشغيل القياسية لشرطة سان أندرياس. بناءً على معرفتك بهذا الكتيب، أجب على الاستفسار التالي: ${prompt}. اجابتك يجب أن تكون موجزة ومباشرة، ومرتبطة بإجراءات الشرطة.` }] });

                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyBmgwfd6KlrPbzN4H85jeB1NBupAqdHzAM"; // اترك هذا كما هو، سيتم توفيره تلقائياً في وقت التشغيل
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    responseOutput.textContent = result.candidates[0].content.parts[0].text;
                } else {
                    responseOutput.textContent = "عذراً، لم أتمكن من الحصول على رد. يرجى المحاولة مرة أخرى.";
                    console.error("Gemini API response structure unexpected:", result);
                }
            } catch (error) {
                responseOutput.textContent = "حدث خطأ أثناء الاتصال بالنموذج. يرجى التحقق من اتصالك بالإنترنت والمحاولة مرة أخرى.";
                console.error("Error calling Gemini API:", error);
            } finally {
                loadingIndicator.classList.add('hidden');
                submitButton.disabled = false;
            }
        }


        // التهيئة
        toc.forEach(item => {
            // إنشاء روابط الشريط الجانبي
            const link = document.createElement('a');
            link.href = '#';
            link.textContent = item.title;
            link.dataset.section = item.id;
            link.classList.add('block', 'p-2', 'rounded-md', 'hover:bg-sky-700', 'transition-colors', 'sidebar-link');
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(item.id);
            });
            tocNav.appendChild(link);

            // إنشاء أقسام المحتوى
            const sectionDiv = document.createElement('div');
            sectionDiv.id = item.id;
            sectionDiv.classList.add('content-section', 'prose', 'prose-slate', 'max-w-none');
            // إزالة أنماط prose من حاوية المخطط لتجنب التعارضات
            if (item.id === 's2_1') {
                sectionDiv.classList.remove('prose', 'prose-slate');
            }
            sectionDiv.innerHTML = contentData[item.id] || `<h2 class="text-2xl font-semibold text-sky-700">${item.title}</h2><p>محتوى هذا القسم غير متوفر حاليًا.</p>`;
            contentArea.appendChild(sectionDiv);
            
            // تهيئة الأكورديونات داخل هذا القسم
            sectionDiv.querySelectorAll('.accordion').forEach(createAccordion);
        });

        showSection(toc[0].id); // عرض القسم الأول افتراضياً

        // ربط زر الاستشارة السريعة بوظيفة استدعاء LLM
        document.getElementById('llm-submit-btn').addEventListener('click', callGeminiAPI);

    </script>
</body>
</html>
